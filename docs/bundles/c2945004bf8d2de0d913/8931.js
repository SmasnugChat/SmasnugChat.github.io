"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[8931],{"./node_modules/matrix-js-sdk/src/rendezvous/index.ts":(e,t,i)=>{i.d(t,{fF:()=>g,n$:()=>w,_T:()=>y,NF:()=>_,G_:()=>v,Qd:()=>p,E$:()=>f});var s=i("./node_modules/matrix-events-sdk/lib/index.js"),n=(i("./node_modules/matrix-js-sdk/src/client.ts"),i("./node_modules/matrix-js-sdk/src/feature.ts"),i("./node_modules/matrix-js-sdk/src/logger.ts")),r=i("./node_modules/matrix-js-sdk/src/utils.ts");i("./node_modules/matrix-js-sdk/src/crypto-api/index.ts");new s.UnstableValue("login_token","org.matrix.msc3906.login_token");var o=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),a=i("./node_modules/@matrix-org/matrix-sdk-crypto-wasm/pkg/index.js"),c=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),d=i("./node_modules/matrix-js-sdk/src/oidc/index.ts");function l(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function h(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?l(Object(i),!0).forEach((function(t){(0,o.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):l(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let u=function(e){return e.Protocols="m.login.protocols",e.Protocol="m.login.protocol",e.Failure="m.login.failure",e.Success="m.login.success",e.Secrets="m.login.secrets",e.ProtocolAccepted="m.login.protocol_accepted",e.Declined="m.login.declined",e}({});class v{get checkCode(){var e;return null===(e=this.channel)||void 0===e?void 0:e.getCheckCode()}constructor(e,t,i,s){(0,o.A)(this,"ourIntent",void 0),(0,o.A)(this,"_code",void 0),(0,o.A)(this,"expectingNewDeviceId",void 0),this.channel=e,this.didScanCode=t,this.client=i,this.onFailure=s,this.ourIntent=i?a.QrCodeMode.Reciprocate:a.QrCodeMode.Login}get code(){return this._code}async generateCode(){this._code||(this.ourIntent===a.QrCodeMode.Reciprocate&&this.client?this._code=await this.channel.generateCode(this.ourIntent,this.client.getDomain()):this.ourIntent===a.QrCodeMode.Login&&(this._code=await this.channel.generateCode(this.ourIntent)))}get isExistingDevice(){return this.ourIntent===a.QrCodeMode.Reciprocate}get isNewDevice(){return!this.isExistingDevice}async negotiateProtocols(){if(n.v.info(`negotiateProtocols(isNewDevice=${this.isNewDevice} didScanCode=${this.didScanCode})`),await this.channel.connect(),this.didScanCode)if(this.isNewDevice);else{var e;let t;try{const{issuer:e}=await this.client.getAuthIssuer();t=await(0,d.k8)(e)}catch(e){n.v.error("Failed to discover OIDC metadata",e)}if(null===(e=t)||void 0===e||!e.metadata.grant_types_supported.includes(d.AO))throw await this.send({type:u.Failure,reason:w.UnsupportedProtocol}),new p("Device code grant unsupported",w.UnsupportedProtocol);await this.send({type:u.Protocols,protocols:["device_authorization_grant"],homeserver:this.client.getDomain()})}else if(this.isNewDevice){n.v.info("Waiting for protocols message");const e=await this.receive();if((null==e?void 0:e.type)===u.Failure)throw new p("Failed",e.reason);if((null==e?void 0:e.type)!==u.Protocols)throw await this.send({type:u.Failure,reason:w.UnexpectedMessageReceived}),new p("Unexpected message received",w.UnexpectedMessageReceived);return{serverName:e.homeserver}}return{}}async deviceAuthorizationGrant(){if(this.isNewDevice)throw new Error("New device flows around OIDC are not yet implemented");{n.v.info("Waiting for protocol message");const t=await this.receive();if((null==t?void 0:t.type)===u.Failure)throw new p("Failed",t.reason);if((null==t?void 0:t.type)!==u.Protocol)throw await this.send({type:u.Failure,reason:w.UnexpectedMessageReceived}),new p("Unexpected message received",w.UnexpectedMessageReceived);if(function(e){return"device_authorization_grant"===e.protocol}(t)){const{device_authorization_grant:i,device_id:s}=t,{verification_uri:n,verification_uri_complete:r}=i;let o=!0;try{var e;await(null===(e=this.client)||void 0===e?void 0:e.getDevice(s))}catch(e){e instanceof c.up&&404===e.httpStatus&&(o=!1)}if(o)throw await this.send({type:u.Failure,reason:w.DeviceAlreadyExists}),new p("Specified device ID already exists",w.DeviceAlreadyExists);return this.expectingNewDeviceId=s,{verificationUri:null!=r?r:n}}throw await this.send({type:u.Failure,reason:w.UnsupportedProtocol}),new p("Received a request for an unsupported protocol",w.UnsupportedProtocol)}}async shareSecrets(){if(this.isNewDevice){await this.send({type:u.Success}),n.v.info("Waiting for secrets message");const e=await this.receive();if((null==e?void 0:e.type)===u.Failure)throw new p("Failed",e.reason);if((null==e?void 0:e.type)!==u.Secrets)throw await this.send({type:u.Failure,reason:w.UnexpectedMessageReceived}),new p("Unexpected message received",w.UnexpectedMessageReceived);return{secrets:e}}{if(!this.expectingNewDeviceId)throw new Error("No new device ID expected");await this.send({type:u.ProtocolAccepted}),n.v.info("Waiting for outcome message");const t=await this.receive();if((null==t?void 0:t.type)===u.Failure)throw new p("Failed",t.reason);if((null==t?void 0:t.type)===u.Declined)throw new p("User declined",g.UserDeclined);if((null==t?void 0:t.type)!==u.Success)throw await this.send({type:u.Failure,reason:w.UnexpectedMessageReceived}),new p("Unexpected message",w.UnexpectedMessageReceived);const i=Date.now()+1e4;do{try{var e;if(await(null===(e=this.client)||void 0===e?void 0:e.getDevice(this.expectingNewDeviceId))){const e=await this.client.getCrypto().exportSecretsBundle();if(this.channel.cancelled)throw new p("User cancelled",w.UserCancelled);return await this.send(h({type:u.Secrets},e)),{secrets:e}}}catch(e){if(!(e instanceof c.up&&404===e.httpStatus))throw e}await(0,r.yy)(1e3)}while(Date.now()<i);throw await this.send({type:u.Failure,reason:w.DeviceNotFound}),new p("New device not found",w.DeviceNotFound)}}async receive(){return await this.channel.secureReceive()}async send(e){await this.channel.secureSend(e)}async declineLoginOnExistingDevice(){if(!this.isExistingDevice)throw new Error("Can only decline login on existing device");await this.send({type:u.Failure,reason:w.UserCancelled})}async cancel(e){var t;null===(t=this.onFailure)||void 0===t||t.call(this,e),await this.channel.cancel(e)}async close(){await this.channel.close()}}class p extends Error{constructor(e,t){super(e),this.code=t}}let w=function(e){return e.AuthorizationExpired="authorization_expired",e.DeviceAlreadyExists="device_already_exists",e.DeviceNotFound="device_not_found",e.UnexpectedMessageReceived="unexpected_message_received",e.UnsupportedProtocol="unsupported_protocol",e.UserCancelled="user_cancelled",e}({}),g=function(e){return e.Expired="expired",e.HomeserverLacksSupport="homeserver_lacks_support",e.InsecureChannelDetected="insecure_channel_detected",e.InvalidCode="invalid_code",e.OtherDeviceNotSignedIn="other_device_not_signed_in",e.OtherDeviceAlreadySignedIn="other_device_already_signed_in",e.Unknown="unknown",e.UserDeclined="user_declined",e.ETagMissing="etag_missing",e}({}),f=function(e){return e.LOGIN_ON_NEW_DEVICE="login.start",e.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE="login.reciprocate",e}({});new s.UnstableValue("http.v1","org.matrix.msc3886.http.v1");var m=i("./node_modules/matrix-js-sdk/src/matrix.ts");class y{constructor({fetchFn:e,onFailure:t,url:i,client:s,fallbackRzServer:n}){(0,o.A)(this,"url",void 0),(0,o.A)(this,"client",void 0),(0,o.A)(this,"fallbackRzServer",void 0),(0,o.A)(this,"fetchFn",void 0),(0,o.A)(this,"onFailure",void 0),(0,o.A)(this,"etag",void 0),(0,o.A)(this,"expiresAt",void 0),(0,o.A)(this,"expiresTimer",void 0),(0,o.A)(this,"_cancelled",!1),(0,o.A)(this,"_ready",!1),this.fetchFn=e,this.onFailure=t,this.client=s,this.fallbackRzServer=n,this.url=i}get ready(){return this._ready}get cancelled(){return this._cancelled}fetch(e,t){return this.fetchFn?this.fetchFn(e,t):i.g.fetch(e,t)}async getPostEndpoint(){if(this.client)try{if(await this.client.doesServerSupportUnstableFeature("org.matrix.msc4108"))return this.client.http.getUrl("/org.matrix.msc4108/rendezvous",void 0,c.iD.Unstable).toString()}catch(e){n.v.warn("Failed to get unstable features",e)}return this.fallbackRzServer}async send(e){var t,i;if(this._cancelled)return;const s=this.url?m.Method.Put:m.Method.Post,r=null!==(t=this.url)&&void 0!==t?t:await this.getPostEndpoint();if(!r)throw new Error("Invalid rendezvous URI");const o={"content-type":"text/plain"};!this.etag&&this.url&&await this.receive(),this.etag&&(o["if-match"]=this.etag),n.v.info(`=> ${s} ${r} with ${e} if-match: ${this.etag}`);const a=await this.fetch(r,{method:s,headers:o,body:e,redirect:"follow"});if(404===a.status)return this.cancel(g.Unknown);if(this.etag=null!==(i=a.headers.get("etag"))&&void 0!==i?i:void 0,n.v.info(`Received etag: ${this.etag}`),s===m.Method.Post){const e=a.headers.get("expires");e&&(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),this.expiresAt=new Date(e),this.expiresTimer=setTimeout((()=>{this.expiresTimer=void 0,this.cancel(g.Expired)}),this.expiresAt.getTime()-Date.now()));const t=await a.json();if("string"!=typeof t.url)throw new Error("No rendezvous URL given");this.url=t.url,this._ready=!0}}async receive(){if(!this.url)throw new Error("Rendezvous not set up");for(;;){var e;if(this._cancelled)return;const t={};this.etag&&(t["if-none-match"]=this.etag),n.v.info(`=> GET ${this.url} if-none-match: ${this.etag}`);const i=await this.fetch(this.url,{method:m.Method.Get,headers:t});if(404===i.status)return void await this.cancel(g.Unknown);const s=null!==(e=i.headers.get("etag"))&&void 0!==e?e:void 0;if("text/plain"!==i.headers.get("content-type"))this.etag=s;else if(200===i.status){if(!s)return void await this.cancel(g.ETagMissing);this.etag=s;const e=await i.text();return n.v.info(`Received: ${e} with etag ${this.etag}`),e}await(0,r.yy)(1e3)}}async cancel(e){var t;this._cancelled||(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),e===g.Unknown&&this.expiresAt&&this.expiresAt.getTime()<Date.now()&&(e=g.Expired),this._cancelled=!0,this._ready=!1,null===(t=this.onFailure)||void 0===t||t.call(this,e),e!==g.UserDeclined&&e!==w.UserCancelled||await this.close())}async close(){if(this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),this.url)try{await this.fetch(this.url,{method:m.Method.Delete})}catch(e){n.v.warn(e)}}}i("./node_modules/matrix-js-sdk/src/base64.ts");new(i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts").qr)("m.rendezvous.v2.curve25519-aes-sha256","org.matrix.msc3903.rendezvous.v2.curve25519-aes-sha256");class _{constructor(e,t,i){(0,o.A)(this,"secureChannel",void 0),(0,o.A)(this,"establishedChannel",void 0),(0,o.A)(this,"connected",!1),this.rendezvousSession=e,this.theirPublicKey=t,this.onFailure=i,this.secureChannel=new a.Ecies}async generateCode(e,t){const{url:i}=this.rendezvousSession;if(!i)throw new Error("No rendezvous session URL");return new a.QrCodeData(this.secureChannel.public_key(),i,e===a.QrCodeMode.Reciprocate?t:void 0).toBytes()}getCheckCode(){var e;const t=null===(e=this.establishedChannel)||void 0===e?void 0:e.check_code();if(t)return Array.from(t.as_bytes()).map((e=>""+e%10)).join("")}async connect(){if(this.connected)throw new Error("Channel already connected");if(this.theirPublicKey){const e=this.secureChannel.establish_outbound_channel(this.theirPublicKey,"MATRIX_QR_CODE_LOGIN_INITIATE");this.establishedChannel=e.channel,n.v.info("Sending LoginInitiateMessage"),await this.rendezvousSession.send(e.initial_message);{n.v.info("Waiting for LoginOkMessage");const e=await this.rendezvousSession.receive();if(!e)throw new p("No response from other device",w.UnexpectedMessageReceived);if("MATRIX_QR_CODE_LOGIN_OK"!==await this.decrypt(e))throw new p("Invalid response from other device",g.InsecureChannelDetected)}}else{n.v.info("Waiting for LoginInitiateMessage");const e=await this.rendezvousSession.receive();if(!e)throw new Error("No response from other device");const{channel:t,message:i}=this.secureChannel.establish_inbound_channel(e);if(this.establishedChannel=t,"MATRIX_QR_CODE_LOGIN_INITIATE"!==i)throw new p("Invalid response from other device",g.InsecureChannelDetected);n.v.info("LoginInitiateMessage received"),n.v.info("Sending LoginOkMessage");const s=await this.encrypt("MATRIX_QR_CODE_LOGIN_OK");await this.rendezvousSession.send(s)}this.connected=!0}async decrypt(e){if(!this.establishedChannel)throw new Error("Channel closed");return this.establishedChannel.decrypt(e)}async encrypt(e){if(!this.establishedChannel)throw new Error("Channel closed");return this.establishedChannel.encrypt(e)}async secureSend(e){if(!this.connected)throw new Error("Channel closed");const t=JSON.stringify(e);n.v.debug(`=> {"type": ${JSON.stringify(e.type)}, ...}`),await this.rendezvousSession.send(await this.encrypt(t))}async secureReceive(){if(!this.establishedChannel)throw new Error("Channel closed");const e=await this.rendezvousSession.receive();if(!e)return;const t=await this.decrypt(e),i=JSON.parse(t);return n.v.debug(`<= {"type": ${JSON.stringify(i.type)}, ...}`),i}async close(){await this.rendezvousSession.close()}async cancel(e){try{var t;await this.rendezvousSession.cancel(e),null===(t=this.onFailure)||void 0===t||t.call(this,e)}finally{await this.close()}}get cancelled(){return this.rendezvousSession.cancelled}}},"./node_modules/@vector-im/compound-web/dist/components/Form/Controls/MFA/MFA.js":(e,t,i)=>{i.d(t,{f:()=>w});var s=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=i("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=i("./node_modules/react/jsx-runtime.js"),o=i("./node_modules/react/index.js");const a="_container_9zyti_18",c="_control_9zyti_33",d="_digit_9zyti_57";var l=i("./node_modules/classnames/index.js");const h=["className","length"];function u(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function v(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?u(Object(i),!0).forEach((function(t){(0,s.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):u(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const p=({filled:e,selected:t})=>(0,r.jsx)("div",{className:d,"aria-hidden":"true","data-filled":e?"":void 0,"data-selected":t?"":void 0}),w=(0,o.forwardRef)((function(e,t){let{className:i,length:s=6}=e,d=(0,n.A)(e,h);const u=l(a,i),[w,g]=o.useState(0),[f,m]=o.useState(null),y=e=>{var t;const i=e.currentTarget;g(null===(t=i.value)||void 0===t?void 0:t.length),document.activeElement!==i||null===i.selectionStart||null===i.selectionEnd?m(null):m([i.selectionStart,i.selectionEnd])};return(0,r.jsxs)("div",{className:u,children:[(0,r.jsx)("input",v(v({},d),{},{inputMode:"numeric",type:"text",minLength:0,maxLength:s,className:c,pattern:`\\d{${s}}`,autoComplete:"one-time-code",onSelect:y,onFocus:y,onBlur:y,onMouseDown:y,onMouseMove:y,onMouseUp:y,onChange:y,ref:t})),Array.from(Array(s).keys()).map((e=>(0,r.jsx)(p,{filled:e<w,selected:!!f&&e>=f[0]&&e<f[1]},e)))]})}))}}]);
//# sourceMappingURL=8931.js.map