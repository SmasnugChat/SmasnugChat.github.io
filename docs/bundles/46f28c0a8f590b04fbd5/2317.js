"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[2317],{"./src/components/views/auth/LoginWithQR.tsx":(e,t,n)=>{n.r(t),n.d(t,{LoginWithQRFailureReason:()=>O,default:()=>Q});var i,o=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=n("./node_modules/react/index.js"),r=n("./node_modules/matrix-js-sdk/src/rendezvous/index.ts"),a=n("./node_modules/matrix-js-sdk/src/logger.ts"),c=n("./node_modules/matrix-js-sdk/src/matrix.ts"),l=n("./src/components/views/auth/LoginWithQR-types.ts"),d=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chevron-left.js"),h=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check-circle-solid.js"),u=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/error.js"),_=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Text.js"),p=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Heading.js"),m=n("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/MFA/MFA.js"),v=n("./node_modules/classnames/index.js"),g=n.n(v),f=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/qr-code.js"),w=n("./src/languageHandler.tsx"),E=n("./src/components/views/elements/AccessibleButton.tsx"),k=n("./src/components/views/elements/QRCode.tsx"),C=n("./src/components/views/elements/Spinner.tsx");function R(){return R=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},R.apply(null,arguments)}var b=function(e,t){return s.createElement("svg",R({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),i||(i=s.createElement("path",{fill:"#000",fillRule:"evenodd",d:"M12 10a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m-1 3a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1v3.5h.5a1 1 0 1 1 0 2H12a1 1 0 0 1-1-1z",clipRule:"evenodd"})))},y=(0,s.forwardRef)(b);var x=n("./src/SdkConfig.ts"),S=n("./src/components/structures/ErrorMessage.tsx"),F=n("./node_modules/buffer/index.js").hp;class q extends s.Component{constructor(e){super(e),(0,o.A)(this,"checkCodeInput",(0,s.createRef)()),(0,o.A)(this,"handleClick",(e=>async t=>{var n;t.preventDefault(),await this.props.onClick(e,e===l.HY.Approve?null===(n=this.checkCodeInput.current)||void 0===n?void 0:n.value:void 0)})),(0,o.A)(this,"cancelButton",(()=>s.createElement(E.A,{kind:"primary_outline",onClick:this.handleClick(l.HY.Cancel)},(0,w._t)("action|cancel")))),(0,o.A)(this,"simpleSpinner",(e=>s.createElement("div",{className:"mx_LoginWithQR_spinner"},s.createElement("div",null,s.createElement(C.A,null),e&&s.createElement("p",null,e)))))}render(){let e,t,n=!0,i="";switch(this.props.phase){case l.a0.Error:{n=!1;let t,o,a=u.A,c=!1;switch(this.props.failureReason){case r.n$.UnsupportedProtocol:case r.t6.UnsupportedProtocol:t=(0,w._t)("auth|qr_code_login|error_unsupported_protocol_title"),o=(0,w._t)("auth|qr_code_login|error_unsupported_protocol");break;case r.n$.UserCancelled:case r.t6.UserCancelled:t=(0,w._t)("auth|qr_code_login|error_user_cancelled_title"),o=(0,w._t)("auth|qr_code_login|error_user_cancelled");break;case r.n$.AuthorizationExpired:case r.fF.Expired:case r.t6.Expired:t=(0,w._t)("auth|qr_code_login|error_expired_title"),o=(0,w._t)("auth|qr_code_login|error_expired");break;case r.fF.InsecureChannelDetected:t=(0,w._t)("auth|qr_code_login|error_insecure_channel_detected_title"),o=s.createElement(s.Fragment,null,(0,w._t)("auth|qr_code_login|error_insecure_channel_detected"),s.createElement(_.E,{as:"h2",size:"lg",weight:"semibold"},(0,w._t)("auth|qr_code_login|error_insecure_channel_detected_instructions")),s.createElement("ol",null,s.createElement("li",null,(0,w._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_1")),s.createElement("li",null,(0,w._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_2")),s.createElement("li",null,(0,w._t)("auth|qr_code_login|error_insecure_channel_detected_instructions_3"))));break;case r.fF.OtherDeviceAlreadySignedIn:c=!0,a=h.A,t=(0,w._t)("auth|qr_code_login|error_other_device_already_signed_in_title"),o=(0,w._t)("auth|qr_code_login|error_other_device_already_signed_in");break;case r.fF.UserDeclined:t=(0,w._t)("auth|qr_code_login|error_user_declined_title"),o=(0,w._t)("auth|qr_code_login|error_user_declined");break;case O.RateLimited:t=(0,w._t)("error|something_went_wrong"),o=(0,w._t)("auth|qr_code_login|error_rate_limited");break;case r.fF.ETagMissing:t=(0,w._t)("error|something_went_wrong"),o=(0,w._t)("auth|qr_code_login|error_etag_missing");break;case r.t6.HomeserverLacksSupport:case r.fF.HomeserverLacksSupport:c=null,a=f.A,n=!0,t=(0,w._t)("auth|qr_code_login|unsupported_heading"),o=(0,w._t)("auth|qr_code_login|unsupported_explainer");break;case r.n$.DeviceAlreadyExists:case r.n$.DeviceNotFound:case r.n$.UnexpectedMessageReceived:case r.fF.OtherDeviceNotSignedIn:case r.fF.Unknown:default:t=(0,w._t)("error|something_went_wrong"),o=(0,w._t)("auth|qr_code_login|error_unexpected")}i="mx_LoginWithQR_error",e=s.createElement(s.Fragment,null,s.createElement("div",{className:g()("mx_LoginWithQR_icon",{"mx_LoginWithQR_icon--critical":!1===c,"mx_LoginWithQR_icon--success":!0===c})},s.createElement(a,{width:"32px",height:"32px"})),s.createElement(p.D,{as:"h1",size:"sm",weight:"semibold"},t),"object"==typeof o?o:s.createElement("p",null,o));break}case l.a0.LegacyConnected:n=!1,e=s.createElement(s.Fragment,null,s.createElement("p",null,(0,w._t)("auth|qr_code_login|confirm_code_match")),s.createElement("div",{className:"mx_LoginWithQR_confirmationDigits"},this.props.confirmationDigits),s.createElement("div",{className:"mx_LoginWithQR_confirmationAlert"},s.createElement("div",null,s.createElement(y,null)),s.createElement("div",null,(0,w._t)("auth|qr_code_login|approve_access_warning")))),t=s.createElement(s.Fragment,null,s.createElement(E.A,{kind:"primary",onClick:this.handleClick(l.HY.Approve)},(0,w._t)("action|approve")),s.createElement(E.A,{kind:"primary_outline",onClick:this.handleClick(l.HY.Decline)},(0,w._t)("action|cancel")));break;case l.a0.OutOfBandConfirmation:n=!1,e=s.createElement(s.Fragment,null,s.createElement(p.D,{as:"h1",size:"sm",weight:"semibold"},(0,w._t)("auth|qr_code_login|check_code_heading")),s.createElement(_.E,{size:"md"},(0,w._t)("auth|qr_code_login|check_code_explainer")),s.createElement("label",{htmlFor:"mx_LoginWithQR_checkCode"},(0,w._t)("auth|qr_code_login|check_code_input_label")),s.createElement(m.f,{className:"mx_LoginWithQR_checkCode_input mx_no_textinput",ref:this.checkCodeInput,length:2,autoFocus:!0,id:"mx_LoginWithQR_checkCode","data-invalid":this.props.failureReason===O.CheckCodeMismatch||void 0}),s.createElement(S.K,{message:this.props.failureReason===O.CheckCodeMismatch?(0,w._t)("auth|qr_code_login|check_code_mismatch"):null})),t=s.createElement(s.Fragment,null,s.createElement(E.A,{kind:"primary",onClick:this.handleClick(l.HY.Approve)},(0,w._t)("action|continue")),s.createElement(E.A,{kind:"primary_outline",onClick:this.handleClick(l.HY.Decline)},(0,w._t)("action|cancel")));break;case l.a0.ShowingQR:if(this.props.code){var o;const t="string"!=typeof this.props.code?this.props.code:F.from(null!==(o=this.props.code)&&void 0!==o?o:"");e=s.createElement(s.Fragment,null,s.createElement(p.D,{as:"h1",size:"sm",weight:"semibold"},(0,w._t)("auth|qr_code_login|scan_code_instruction")),s.createElement("div",{className:"mx_LoginWithQR_qrWrapper"},s.createElement(k.A,{data:[{data:t,mode:"byte"}],className:"mx_QRCode"})),s.createElement("ol",null,s.createElement("li",null,(0,w._t)("auth|qr_code_login|open_element_other_device",{brand:x.Ay.get().brand})),s.createElement("li",null,(0,w._t)("auth|qr_code_login|select_qr_code",{scanQRCode:s.createElement("strong",null,(0,w._t)("auth|qr_code_login|scan_qr_code"))})),s.createElement("li",null,(0,w._t)("auth|qr_code_login|point_the_camera")),s.createElement("li",null,(0,w._t)("auth|qr_code_login|follow_remaining_instructions"))))}else e=this.simpleSpinner(),t=this.cancelButton();break;case l.a0.Loading:e=this.simpleSpinner();break;case l.a0.WaitingForDevice:e=s.createElement(s.Fragment,null,this.simpleSpinner((0,w._t)("auth|qr_code_login|waiting_for_device")),this.props.userCode?s.createElement("div",null,s.createElement("p",null,(0,w._t)("auth|qr_code_login|security_code")),s.createElement("p",null,(0,w._t)("auth|qr_code_login|security_code_prompt")),s.createElement("p",null,this.props.userCode)):null),t=this.cancelButton();break;case l.a0.Verifying:e=this.simpleSpinner((0,w._t)("auth|qr_code_login|completing_setup"))}return s.createElement("div",{className:g()("mx_LoginWithQR",i)},n?s.createElement("div",{className:"mx_LoginWithQR_heading"},s.createElement(E.A,{className:"mx_LoginWithQR_BackButton",onClick:this.handleClick(l.HY.Back),title:"Back"},s.createElement(d.A,null)),s.createElement("div",{className:"mx_LoginWithQR_breadcrumbs"},(0,w._t)("settings|sessions|title")," / ",(0,w._t)("settings|sessions|sign_in_with_qr"))):null,s.createElement("div",{className:"mx_LoginWithQR_main"},e),s.createElement("div",{className:"mx_LoginWithQR_buttons"},t))}}var A=n("./src/Modal.tsx"),L=n("./src/components/views/dialogs/InteractiveAuthDialog.tsx");function z(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function D(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?z(Object(n),!0).forEach((function(t){(0,o.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):z(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let O=function(e){return e.RateLimited="rate_limited",e.CheckCodeMismatch="check_code_mismatch",e}({});class Q extends s.Component{constructor(e){super(e),(0,o.A)(this,"finished",!1),(0,o.A)(this,"generateAndShowCode",(async()=>{let e;try{var t;const n=null===(t=this.props.client)||void 0===t||null===(t=t.getClientWellKnown())||void 0===t||null===(t=t["io.element.rendezvous"])||void 0===t?void 0:t.server;if(this.props.legacy){const t=new r.xB({onFailure:this.onFailure,client:this.props.client,fallbackRzServer:n}),i=new r.Fj(t,void 0,this.onFailure);e=new r.Rh(i,this.props.client,this.onFailure)}else{const t=new r._T({onFailure:this.onFailure,client:this.props.client,fallbackRzServer:n});await t.send("");const i=new r.NF(t,void 0,this.onFailure);e=new r.G_(i,!1,this.props.client,this.onFailure)}await e.generateCode(),this.setState({phase:l.a0.ShowingQR,rendezvous:e,failureReason:void 0})}catch(e){return a.v.error("Error whilst generating QR code",e),void this.setState({phase:l.a0.Error,failureReason:r.fF.HomeserverLacksSupport})}try{if(e instanceof r.Rh){const t=await e.startAfterShowingCode();this.setState({phase:l.a0.LegacyConnected,confirmationDigits:t})}else if(this.ourIntent===r.E$.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE){await e.negotiateProtocols();const{verificationUri:t}=await e.deviceAuthorizationGrant();this.setState({phase:l.a0.OutOfBandConfirmation,verificationUri:t})}}catch(t){var n;if(a.v.error("Error whilst approving login",t),e instanceof r.Rh)this.state.phase!==l.a0.Error&&this.setState({phase:l.a0.Error,failureReason:r.t6.Unknown});else await(null===(n=e)||void 0===n?void 0:n.cancel(t instanceof r.Qd?t.code:r.fF.Unknown))}})),(0,o.A)(this,"approveLogin",(async e=>{var t;if(!(this.state.rendezvous instanceof r.G_))throw this.setState({phase:l.a0.Error,failureReason:r.fF.Unknown}),new Error("Rendezvous not found");if(this.state.lastScannedCode||(null===(t=this.state.rendezvous)||void 0===t?void 0:t.checkCode)===e)try{if(this.ourIntent!==r.E$.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE)throw this.setState({phase:l.a0.Error,failureReason:r.fF.Unknown}),new Error("New device flows around OIDC are not yet implemented");this.setState({phase:l.a0.Loading}),this.state.verificationUri&&window.open(this.state.verificationUri,"_blank"),this.setState({phase:l.a0.WaitingForDevice}),await this.state.rendezvous.shareSecrets(),this.onFinished(!0)}catch(e){a.v.error("Error whilst approving sign in",e),this.setState({phase:l.a0.Error,failureReason:e instanceof r.Qd?e.code:r.fF.Unknown})}else this.setState({failureReason:O.CheckCodeMismatch})})),(0,o.A)(this,"onFailure",(e=>{this.state.phase!==l.a0.Error&&(a.v.info(`Rendezvous failed: ${e}`),this.setState({phase:l.a0.Error,failureReason:e}))})),(0,o.A)(this,"onClick",(async(e,t)=>{var n;switch(e){case l.HY.Cancel:var i,o;if(this.state.rendezvous instanceof r.Rh)await(null===(i=this.state.rendezvous)||void 0===i?void 0:i.cancel(r.t6.UserCancelled));else await(null===(o=this.state.rendezvous)||void 0===o?void 0:o.cancel(r.n$.UserCancelled));this.reset(),this.onFinished(!1);break;case l.HY.Approve:await(this.props.legacy?this.legacyApproveLogin():this.approveLogin(t));break;case l.HY.Decline:await(null===(n=this.state.rendezvous)||void 0===n?void 0:n.declineLoginOnExistingDevice()),this.reset(),this.onFinished(!1);break;case l.HY.Back:var s,a;if(this.state.rendezvous instanceof r.Rh)await(null===(s=this.state.rendezvous)||void 0===s?void 0:s.cancel(r.t6.UserCancelled));else await(null===(a=this.state.rendezvous)||void 0===a?void 0:a.cancel(r.n$.UserCancelled));this.onFinished(!1);break;case l.HY.ShowQr:await this.updateMode(l.Kt.Show)}})),this.state={phase:l.a0.Loading}}get ourIntent(){return r.E$.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE}componentDidMount(){this.updateMode(this.props.mode).then((()=>{}))}componentDidUpdate(e){e.mode!==this.props.mode&&this.updateMode(this.props.mode).then((()=>{}))}async updateMode(e){if(this.setState({phase:l.a0.Loading}),this.state.rendezvous){const e=this.state.rendezvous;e.onFailure=void 0,e instanceof r.Rh&&await e.cancel(r.t6.UserCancelled),this.setState({rendezvous:void 0})}e===l.Kt.Show&&await this.generateAndShowCode()}componentWillUnmount(){this.state.rendezvous&&!this.finished&&(this.state.rendezvous.onFailure=void 0,this.state.rendezvous instanceof r.Rh?this.state.rendezvous.cancel(r.t6.UserCancelled):this.state.rendezvous.cancel(r.n$.UserCancelled))}async legacyApproveLogin(){if(!(this.state.rendezvous instanceof r.Rh))throw new Error("Rendezvous not found");if(!this.props.client)throw new Error("No client to approve login with");this.setState({phase:l.a0.Loading});try{a.v.info("Requesting login token");const{login_token:n}=await(e=this.props.client.requestLoginToken,t={matrixClient:this.props.client,title:(0,w._t)("auth|qr_code_login|sign_in_new_device")},async function(...n){return new Promise(((i,o)=>{const s=e.bind(t.matrixClient);s(void 0,...n).then((e=>i(e))).catch((e=>{var r;if(401!==e.httpStatus||null===(r=e.data)||void 0===r||!r.flows)return o(e);A.Ay.createDialog(L.A,D(D({},t),{},{authData:e.data,makeRequest:e=>s(e,...n),onFinished:(e,t)=>{e?i(t):o(t)}}))}))}))})();this.setState({phase:l.a0.WaitingForDevice});if(!await this.state.rendezvous.approveLoginOnExistingDevice(n))return;if(!this.props.client.getCrypto())return void this.onFinished(!0);this.setState({phase:l.a0.Verifying}),await this.state.rendezvous.verifyNewDeviceOnExistingDevice();try{await this.state.rendezvous.close()}finally{this.setState({rendezvous:void 0})}this.onFinished(!0)}catch(e){if(a.v.error("Error whilst approving sign in",e),e instanceof c.HTTPError&&429===e.httpStatus)return void this.setState({phase:l.a0.Error,failureReason:O.RateLimited});this.setState({phase:l.a0.Error,failureReason:r.fF.Unknown})}var e,t}onFinished(e){this.finished=!0,this.props.onFinished(e)}reset(){this.setState({rendezvous:void 0,confirmationDigits:void 0,verificationUri:void 0,failureReason:void 0,userCode:void 0,checkCode:void 0,lastScannedCode:void 0,mediaPermissionError:!1})}render(){var e,t;return this.state.rendezvous instanceof r.Rh?s.createElement(q,{onClick:this.onClick,phase:this.state.phase,code:this.state.phase===l.a0.ShowingQR?null===(t=this.state.rendezvous)||void 0===t?void 0:t.code:void 0,confirmationDigits:this.state.phase===l.a0.LegacyConnected?this.state.confirmationDigits:void 0,failureReason:this.state.failureReason}):s.createElement(q,{onClick:this.onClick,phase:this.state.phase,code:this.state.phase===l.a0.ShowingQR?null===(e=this.state.rendezvous)||void 0===e?void 0:e.code:void 0,failureReason:this.state.failureReason,userCode:this.state.userCode,checkCode:this.state.checkCode})}}}}]);
//# sourceMappingURL=2317.js.map